function cov_2a6hshjnrv(){var path="D:\\repository\\mychat\\chatserver\\dao\\friend.js";var hash="6ca10123ffcbd2d9cfa4ebb8e4d89da2da72c731";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"D:\\repository\\mychat\\chatserver\\dao\\friend.js",statementMap:{"0":{start:{line:1,column:15},end:{line:1,column:41}},"1":{start:{line:2,column:26},end:{line:2,column:60}},"2":{start:{line:5,column:4},end:{line:5,column:79}},"3":{start:{line:5,column:39},end:{line:5,column:79}},"4":{start:{line:6,column:17},end:{line:6,column:68}},"5":{start:{line:7,column:4},end:{line:7,column:55}},"6":{start:{line:7,column:16},end:{line:7,column:55}},"7":{start:{line:8,column:4},end:{line:8,column:64}},"8":{start:{line:9,column:4},end:{line:16,column:5}},"9":{start:{line:9,column:54},end:{line:9,column:101}},"10":{start:{line:10,column:9},end:{line:16,column:5}},"11":{start:{line:10,column:20},end:{line:16,column:5}},"12":{start:{line:17,column:20},end:{line:17,column:24}},"13":{start:{line:18,column:4},end:{line:28,column:5}},"14":{start:{line:19,column:8},end:{line:25,column:10}},"15":{start:{line:27,column:8},end:{line:27,column:24}},"16":{start:{line:29,column:4},end:{line:35,column:5}},"17":{start:{line:39,column:19},end:{line:39,column:59}},"18":{start:{line:40,column:4},end:{line:40,column:26}},"19":{start:{line:41,column:4},end:{line:41,column:18}},"20":{start:{line:42,column:4},end:{line:42,column:17}},"21":{start:{line:46,column:21},end:{line:58,column:6}},"22":{start:{line:47,column:8},end:{line:57,column:10}},"23":{start:{line:59,column:18},end:{line:59,column:45}},"24":{start:{line:60,column:4},end:{line:69,column:10}},"25":{start:{line:62,column:8},end:{line:66,column:10}},"26":{start:{line:63,column:12},end:{line:63,column:42}},"27":{start:{line:64,column:12},end:{line:64,column:34}},"28":{start:{line:65,column:12},end:{line:65,column:25}},"29":{start:{line:67,column:8},end:{line:67,column:43}},"30":{start:{line:68,column:8},end:{line:68,column:21}},"31":{start:{line:70,column:4},end:{line:70,column:18}},"32":{start:{line:74,column:18},end:{line:84,column:6}},"33":{start:{line:85,column:4},end:{line:87,column:6}},"34":{start:{line:86,column:8},end:{line:86,column:36}},"35":{start:{line:88,column:4},end:{line:88,column:18}},"36":{start:{line:92,column:16},end:{line:92,column:25}},"37":{start:{line:93,column:4},end:{line:93,column:93}},"38":{start:{line:94,column:4},end:{line:94,column:87}},"39":{start:{line:95,column:4},end:{line:111,column:5}},"40":{start:{line:114,column:0},end:{line:119,column:1}}},fnMap:{"0":{name:"addFriend",decl:{start:{line:4,column:15},end:{line:4,column:24}},loc:{start:{line:4,column:41},end:{line:36,column:1}},line:4},"1":{name:"updateFriend",decl:{start:{line:38,column:15},end:{line:38,column:27}},loc:{start:{line:38,column:44},end:{line:43,column:1}},line:38},"2":{name:"findFriendByToIds",decl:{start:{line:45,column:15},end:{line:45,column:32}},loc:{start:{line:45,column:38},end:{line:71,column:1}},line:45},"3":{name:"(anonymous_3)",decl:{start:{line:46,column:29},end:{line:46,column:30}},loc:{start:{line:46,column:35},end:{line:58,column:5}},line:46},"4":{name:"(anonymous_4)",decl:{start:{line:60,column:25},end:{line:60,column:26}},loc:{start:{line:60,column:48},end:{line:69,column:5}},line:60},"5":{name:"(anonymous_5)",decl:{start:{line:62,column:44},end:{line:62,column:45}},loc:{start:{line:62,column:54},end:{line:66,column:9}},line:62},"6":{name:"findFriendByTo",decl:{start:{line:73,column:15},end:{line:73,column:29}},loc:{start:{line:73,column:34},end:{line:89,column:1}},line:73},"7":{name:"(anonymous_7)",decl:{start:{line:85,column:26},end:{line:85,column:27}},loc:{start:{line:85,column:36},end:{line:87,column:5}},line:85},"8":{name:"convertFriend",decl:{start:{line:91,column:9},end:{line:91,column:22}},loc:{start:{line:91,column:31},end:{line:112,column:1}},line:91}},branchMap:{"0":{loc:{start:{line:5,column:4},end:{line:5,column:79}},type:"if",locations:[{start:{line:5,column:4},end:{line:5,column:79}},{start:{line:5,column:4},end:{line:5,column:79}}],line:5},"1":{loc:{start:{line:7,column:4},end:{line:7,column:55}},type:"if",locations:[{start:{line:7,column:4},end:{line:7,column:55}},{start:{line:7,column:4},end:{line:7,column:55}}],line:7},"2":{loc:{start:{line:9,column:4},end:{line:16,column:5}},type:"if",locations:[{start:{line:9,column:4},end:{line:16,column:5}},{start:{line:9,column:4},end:{line:16,column:5}}],line:9},"3":{loc:{start:{line:9,column:7},end:{line:9,column:52}},type:"binary-expr",locations:[{start:{line:9,column:7},end:{line:9,column:13}},{start:{line:9,column:17},end:{line:9,column:52}}],line:9},"4":{loc:{start:{line:10,column:9},end:{line:16,column:5}},type:"if",locations:[{start:{line:10,column:9},end:{line:16,column:5}},{start:{line:10,column:9},end:{line:16,column:5}}],line:10},"5":{loc:{start:{line:93,column:4},end:{line:93,column:93}},type:"binary-expr",locations:[{start:{line:93,column:4},end:{line:93,column:33}},{start:{line:93,column:38},end:{line:93,column:92}}],line:93},"6":{loc:{start:{line:94,column:4},end:{line:94,column:87}},type:"binary-expr",locations:[{start:{line:94,column:4},end:{line:94,column:31}},{start:{line:94,column:36},end:{line:94,column:86}}],line:94}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"6ca10123ffcbd2d9cfa4ebb8e4d89da2da72c731"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_2a6hshjnrv=function(){return actualCoverage;};return actualCoverage;}cov_2a6hshjnrv();const Friend=(cov_2a6hshjnrv().s[0]++,require('../model/friend'));const{getAvatarData}=(cov_2a6hshjnrv().s[1]++,require('../util/getRandomAvatar'));async function addFriend({id,from,to}){cov_2a6hshjnrv().f[0]++;cov_2a6hshjnrv().s[2]++;if(from.username===to.username){cov_2a6hshjnrv().b[0][0]++;cov_2a6hshjnrv().s[3]++;return{status:400,msg:'不能添加自己为好友'};}else{cov_2a6hshjnrv().b[0][1]++;}let friend=(cov_2a6hshjnrv().s[4]++,await Friend.findOne({relationId:id,status:1}));cov_2a6hshjnrv().s[5]++;if(friend){cov_2a6hshjnrv().b[1][0]++;cov_2a6hshjnrv().s[6]++;return{status:400,msg:'你们已经是好友了'};}else{cov_2a6hshjnrv().b[1][1]++;}cov_2a6hshjnrv().s[7]++;friend=await Friend.findOne({relationId:id,status:0});cov_2a6hshjnrv().s[8]++;if((cov_2a6hshjnrv().b[3][0]++,friend)&&(cov_2a6hshjnrv().b[3][1]++,friend.from.toString()!==from._id)){cov_2a6hshjnrv().b[2][0]++;cov_2a6hshjnrv().s[9]++;return{status:400,msg:'对方正在请求添加你为好友，请进行回复'};}else{cov_2a6hshjnrv().b[2][1]++;cov_2a6hshjnrv().s[10]++;if(friend){cov_2a6hshjnrv().b[4][0]++;cov_2a6hshjnrv().s[11]++;return{id:friend.relationId,from:friend.from,to:friend.to,createTime:friend.createTime,status:friend.status};}else{cov_2a6hshjnrv().b[4][1]++;}}let newFriend=(cov_2a6hshjnrv().s[12]++,null);cov_2a6hshjnrv().s[13]++;try{cov_2a6hshjnrv().s[14]++;newFriend=await Friend.create({relationId:id,from:from,to:to,createTime:new Date(),status:0});}catch(err){cov_2a6hshjnrv().s[15]++;console.log(err);}cov_2a6hshjnrv().s[16]++;return{id:newFriend.relationId,from:newFriend.from,to:newFriend.to,createTime:newFriend.createTime,status:newFriend.status};}async function updateFriend({id,status}){cov_2a6hshjnrv().f[1]++;const friend=(cov_2a6hshjnrv().s[17]++,await Friend.findOne({relationId:id}));cov_2a6hshjnrv().s[18]++;friend.status=status;cov_2a6hshjnrv().s[19]++;friend.save();cov_2a6hshjnrv().s[20]++;return friend;}async function findFriendByToIds(ids){cov_2a6hshjnrv().f[2]++;const promises=(cov_2a6hshjnrv().s[21]++,ids.map(id=>{cov_2a6hshjnrv().f[3]++;cov_2a6hshjnrv().s[22]++;return Friend.find({$or:[{to:id},{from:id}]}).populate('from',{_id:1,username:1,avatar:1,tag:1}).populate('to',{_id:1,username:1,avatar:1,tag:1});}));let results=(cov_2a6hshjnrv().s[23]++,await Promise.all(promises));cov_2a6hshjnrv().s[24]++;results=ids.reduce((result,id,index)=>{cov_2a6hshjnrv().f[4]++;let relationId;cov_2a6hshjnrv().s[25]++;results[index]=results[index].map(friend=>{cov_2a6hshjnrv().f[5]++;cov_2a6hshjnrv().s[26]++;friend=convertFriend(friend);cov_2a6hshjnrv().s[27]++;relationId=friend.id;cov_2a6hshjnrv().s[28]++;return friend;});cov_2a6hshjnrv().s[29]++;result[relationId]=results[index];cov_2a6hshjnrv().s[30]++;return result;},{});cov_2a6hshjnrv().s[31]++;return results;}async function findFriendByTo(id){cov_2a6hshjnrv().f[6]++;let friends=(cov_2a6hshjnrv().s[32]++,await Friend.find({to:id,status:0}).populate('from',{_id:1,username:1,avatar:1,tag:1}).populate('to',{_id:1,username:1,avatar:1,tag:1}));cov_2a6hshjnrv().s[33]++;friends=friends.map(friend=>{cov_2a6hshjnrv().f[7]++;cov_2a6hshjnrv().s[34]++;return convertFriend(friend);});cov_2a6hshjnrv().s[35]++;return friends;}function convertFriend(friend){cov_2a6hshjnrv().f[8]++;const reg=(cov_2a6hshjnrv().s[36]++,/base64/g);cov_2a6hshjnrv().s[37]++;(cov_2a6hshjnrv().b[5][0]++,!reg.test(friend.from.avatar))&&(cov_2a6hshjnrv().b[5][1]++,friend.from.avatar=getAvatarData(friend.from.avatar));cov_2a6hshjnrv().s[38]++;(cov_2a6hshjnrv().b[6][0]++,!reg.test(friend.to.avatar))&&(cov_2a6hshjnrv().b[6][1]++,friend.to.avatar=getAvatarData(friend.to.avatar));cov_2a6hshjnrv().s[39]++;return{id:friend.relationId,from:{_id:friend.from._id,username:friend.from.username,avatar:friend.from.avatar,tag:friend.from.tag},to:{_id:friend.to._id,username:friend.to.username,avatar:friend.to.avatar,tag:friend.to.tag},createTime:friend.createTime,status:friend.status};}cov_2a6hshjnrv().s[40]++;module.exports={addFriend,updateFriend,findFriendByToIds,findFriendByTo};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZyaWVuZC5qcyJdLCJuYW1lcyI6WyJGcmllbmQiLCJyZXF1aXJlIiwiZ2V0QXZhdGFyRGF0YSIsImFkZEZyaWVuZCIsImlkIiwiZnJvbSIsInRvIiwidXNlcm5hbWUiLCJzdGF0dXMiLCJtc2ciLCJmcmllbmQiLCJmaW5kT25lIiwicmVsYXRpb25JZCIsInRvU3RyaW5nIiwiX2lkIiwiY3JlYXRlVGltZSIsIm5ld0ZyaWVuZCIsImNyZWF0ZSIsIkRhdGUiLCJlcnIiLCJjb25zb2xlIiwibG9nIiwidXBkYXRlRnJpZW5kIiwic2F2ZSIsImZpbmRGcmllbmRCeVRvSWRzIiwiaWRzIiwicHJvbWlzZXMiLCJtYXAiLCJmaW5kIiwiJG9yIiwicG9wdWxhdGUiLCJhdmF0YXIiLCJ0YWciLCJyZXN1bHRzIiwiUHJvbWlzZSIsImFsbCIsInJlZHVjZSIsInJlc3VsdCIsImluZGV4IiwiY29udmVydEZyaWVuZCIsImZpbmRGcmllbmRCeVRvIiwiZnJpZW5kcyIsInJlZyIsInRlc3QiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiMDRMQUFBLEtBQU1BLENBQUFBLE1BQU0sMEJBQUdDLE9BQU8sQ0FBQyxpQkFBRCxDQUFWLENBQVosQ0FDQSxLQUFNLENBQUVDLGFBQUYsMkJBQW9CRCxPQUFPLENBQUMseUJBQUQsQ0FBM0IsQ0FBTixDQUVBLGNBQWVFLENBQUFBLFNBQWYsQ0FBeUIsQ0FBQ0MsRUFBRCxDQUFLQyxJQUFMLENBQVdDLEVBQVgsQ0FBekIsQ0FBeUMsaURBQ3JDLEdBQUlELElBQUksQ0FBQ0UsUUFBTCxHQUFrQkQsRUFBRSxDQUFDQyxRQUF6QixDQUFtQywwREFBTyxDQUFFQyxNQUFNLENBQUUsR0FBVixDQUFlQyxHQUFHLENBQUUsV0FBcEIsQ0FBUCxDQUF3QyxDQUEzRSxpQ0FDQSxHQUFJQyxDQUFBQSxNQUFNLDBCQUFHLEtBQU1WLENBQUFBLE1BQU0sQ0FBQ1csT0FBUCxDQUFlLENBQUVDLFVBQVUsQ0FBRVIsRUFBZCxDQUFrQkksTUFBTSxD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Q0FBRUcsTUFBTSxDQUFDTCxJQUFQLENBQVlFLFFBRnBCLENBR0Z3QixNQUFNLENBQUVyQixNQUFNLENBQUNMLElBQVAsQ0FBWTBCLE1BSGxCLENBSUZDLEdBQUcsQ0FBRXRCLE1BQU0sQ0FBQ0wsSUFBUCxDQUFZMkIsR0FKZixDQUZILENBUUgxQixFQUFFLENBQUUsQ0FDQVEsR0FBRyxDQUFFSixNQUFNLENBQUNKLEVBQVAsQ0FBVVEsR0FEZixDQUVBUCxRQUFRLENBQUVHLE1BQU0sQ0FBQ0osRUFBUCxDQUFVQyxRQUZwQixDQUdBd0IsTUFBTSxDQUFFckIsTUFBTSxDQUFDSixFQUFQLENBQVV5QixNQUhsQixDQUlBQyxHQUFHLENBQUV0QixNQUFNLENBQUNKLEVBQVAsQ0FBVTBCLEdBSmYsQ0FSRCxDQWNIakIsVUFBVSxDQUFFTCxNQUFNLENBQUNLLFVBZGhCLENBZUhQLE1BQU0sQ0FBRUUsTUFBTSxDQUFDRixNQWZaLENBQVAsQ0FpQkgsQyx5QkFFRG9DLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixDQUNiMUMsU0FEYSxDQUVibUIsWUFGYSxDQUdiRSxpQkFIYSxDQUliZ0IsY0FKYSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEZyaWVuZCA9IHJlcXVpcmUoJy4uL21vZGVsL2ZyaWVuZCcpXHJcbmNvbnN0IHsgZ2V0QXZhdGFyRGF0YSB9ID0gcmVxdWlyZSgnLi4vdXRpbC9nZXRSYW5kb21BdmF0YXInKVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gYWRkRnJpZW5kKHtpZCwgZnJvbSwgdG99KSB7XHJcbiAgICBpZiAoZnJvbS51c2VybmFtZSA9PT0gdG8udXNlcm5hbWUpIHJldHVybiB7IHN0YXR1czogNDAwLCBtc2c6ICfkuI3og73mt7vliqDoh6rlt7HkuLrlpb3lj4snIH1cclxuICAgIGxldCBmcmllbmQgPSBhd2FpdCBGcmllbmQuZmluZE9uZSh7IHJlbGF0aW9uSWQ6IGlkLCBzdGF0dXM6IDEgfSlcclxuICAgIGlmIChmcmllbmQpIHJldHVybiB7IHN0YXR1czogNDAwLCBtc2c6ICfkvaDku6zlt7Lnu4/mmK/lpb3lj4vkuoYnIH1cclxuICAgIGZyaWVuZCA9IGF3YWl0IEZyaWVuZC5maW5kT25lKHsgcmVsYXRpb25JZDogaWQsIHN0YXR1czogMCB9KVxyXG4gICAgaWYoZnJpZW5kICYmIGZyaWVuZC5mcm9tLnRvU3RyaW5nKCkgIT09IGZyb20uX2lkKSByZXR1cm4ge3N0YXR1czogNDAwLCBtc2c6ICflr7nmlrnmraPlnKjor7fmsYLmt7vliqDkvaDkuLrlpb3lj4vvvIzor7fov5vooYzlm57lpI0nfVxyXG4gICAgZWxzZSBpZihmcmllbmQpIHJldHVybiB7XHJcbiAgICAgICAgaWQ6IGZyaWVuZC5yZWxhdGlvbklkLFxyXG4gICAgICAgIGZyb206IGZyaWVuZC5mcm9tLFxyXG4gICAgICAgIHRvOiBmcmllbmQudG8sXHJcbiAgICAgICAgY3JlYXRlVGltZTogZnJpZW5kLmNyZWF0ZVRpbWUsXHJcbiAgICAgICAgc3RhdHVzOiBmcmllbmQuc3RhdHVzXHJcbiAgICB9XHJcbiAgICBsZXQgbmV3RnJpZW5kID0gbnVsbDtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgbmV3RnJpZW5kID0gYXdhaXQgRnJpZW5kLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIHJlbGF0aW9uSWQ6IGlkLFxyXG4gICAgICAgICAgICBmcm9tOiBmcm9tLFxyXG4gICAgICAgICAgICB0bzogdG8sXHJcbiAgICAgICAgICAgIGNyZWF0ZVRpbWU6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgICAgIHN0YXR1czogMFxyXG4gICAgICAgIH0pXHJcbiAgICB9IGNhdGNoKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycilcclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgaWQ6IG5ld0ZyaWVuZC5yZWxhdGlvbklkLFxyXG4gICAgICAgIGZyb206IG5ld0ZyaWVuZC5mcm9tLFxyXG4gICAgICAgIHRvOiBuZXdGcmllbmQudG8sXHJcbiAgICAgICAgY3JlYXRlVGltZTogbmV3RnJpZW5kLmNyZWF0ZVRpbWUsXHJcbiAgICAgICAgc3RhdHVzOiBuZXdGcmllbmQuc3RhdHVzXHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUZyaWVuZCh7IGlkLCBzdGF0dXMgfSkge1xyXG4gICAgY29uc3QgZnJpZW5kID0gYXdhaXQgRnJpZW5kLmZpbmRPbmUoeyByZWxhdGlvbklkOiBpZCB9KVxyXG4gICAgZnJpZW5kLnN0YXR1cyA9IHN0YXR1c1xyXG4gICAgZnJpZW5kLnNhdmUoKTtcclxuICAgIHJldHVybiBmcmllbmRcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZmluZEZyaWVuZEJ5VG9JZHMoaWRzKSB7XHJcbiAgICBjb25zdCBwcm9taXNlcyA9IGlkcy5tYXAoaWQgPT4ge1xyXG4gICAgICAgIHJldHVybiBGcmllbmQuZmluZCh7JG9yOiBbe3RvOiBpZH0sIHtmcm9tOiBpZH1dfSkucG9wdWxhdGUoJ2Zyb20nLCB7XHJcbiAgICAgICAgICAgIF9pZDogMSxcclxuICAgICAgICAgICAgdXNlcm5hbWU6IDEsXHJcbiAgICAgICAgICAgIGF2YXRhcjogMSxcclxuICAgICAgICAgICAgdGFnOiAxXHJcbiAgICAgICAgfSkucG9wdWxhdGUoJ3RvJywge1xyXG4gICAgICAgICAgICBfaWQ6IDEsXHJcbiAgICAgICAgICAgIHVzZXJuYW1lOiAxLFxyXG4gICAgICAgICAgICBhdmF0YXI6IDEsXHJcbiAgICAgICAgICAgIHRhZzogMVxyXG4gICAgICAgIH0pXHJcbiAgICB9KVxyXG4gICAgbGV0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcylcclxuICAgIHJlc3VsdHMgPSBpZHMucmVkdWNlKChyZXN1bHQsIGlkLCBpbmRleCkgPT4ge1xyXG4gICAgICAgIGxldCByZWxhdGlvbklkXHJcbiAgICAgICAgcmVzdWx0c1tpbmRleF0gPSByZXN1bHRzW2luZGV4XS5tYXAoZnJpZW5kID0+IHtcclxuICAgICAgICAgICAgZnJpZW5kID0gY29udmVydEZyaWVuZChmcmllbmQpXHJcbiAgICAgICAgICAgIHJlbGF0aW9uSWQgPSBmcmllbmQuaWRcclxuICAgICAgICAgICAgcmV0dXJuIGZyaWVuZFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcmVzdWx0W3JlbGF0aW9uSWRdID0gcmVzdWx0c1tpbmRleF1cclxuICAgICAgICByZXR1cm4gcmVzdWx0XHJcbiAgICB9LCB7fSlcclxuICAgIHJldHVybiByZXN1bHRzXHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGZpbmRGcmllbmRCeVRvKGlkKSB7XHJcbiAgICBsZXQgZnJpZW5kcyA9IGF3YWl0IEZyaWVuZC5maW5kKHt0bzogaWQsIHN0YXR1czogMH0pLnBvcHVsYXRlKCdmcm9tJywge1xyXG4gICAgICAgIF9pZDogMSxcclxuICAgICAgICB1c2VybmFtZTogMSxcclxuICAgICAgICBhdmF0YXI6IDEsXHJcbiAgICAgICAgdGFnOiAxXHJcbiAgICB9KS5wb3B1bGF0ZSgndG8nLCB7XHJcbiAgICAgICAgX2lkOiAxLFxyXG4gICAgICAgIHVzZXJuYW1lOiAxLFxyXG4gICAgICAgIGF2YXRhcjogMSxcclxuICAgICAgICB0YWc6IDFcclxuICAgIH0pXHJcbiAgICBmcmllbmRzID0gZnJpZW5kcy5tYXAoZnJpZW5kID0+IHtcclxuICAgICAgICByZXR1cm4gY29udmVydEZyaWVuZChmcmllbmQpXHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIGZyaWVuZHNcclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydEZyaWVuZChmcmllbmQpIHtcclxuICAgIGNvbnN0IHJlZyA9IC9iYXNlNjQvZztcclxuICAgICFyZWcudGVzdChmcmllbmQuZnJvbS5hdmF0YXIpICYmIChmcmllbmQuZnJvbS5hdmF0YXIgPSBnZXRBdmF0YXJEYXRhKGZyaWVuZC5mcm9tLmF2YXRhcikpXHJcbiAgICAhcmVnLnRlc3QoZnJpZW5kLnRvLmF2YXRhcikgJiYgKGZyaWVuZC50by5hdmF0YXIgPSBnZXRBdmF0YXJEYXRhKGZyaWVuZC50by5hdmF0YXIpKVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBpZDogZnJpZW5kLnJlbGF0aW9uSWQsXHJcbiAgICAgICAgZnJvbToge1xyXG4gICAgICAgICAgICBfaWQ6IGZyaWVuZC5mcm9tLl9pZCxcclxuICAgICAgICAgICAgdXNlcm5hbWU6IGZyaWVuZC5mcm9tLnVzZXJuYW1lLFxyXG4gICAgICAgICAgICBhdmF0YXI6IGZyaWVuZC5mcm9tLmF2YXRhcixcclxuICAgICAgICAgICAgdGFnOiBmcmllbmQuZnJvbS50YWdcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRvOiB7XHJcbiAgICAgICAgICAgIF9pZDogZnJpZW5kLnRvLl9pZCxcclxuICAgICAgICAgICAgdXNlcm5hbWU6IGZyaWVuZC50by51c2VybmFtZSxcclxuICAgICAgICAgICAgYXZhdGFyOiBmcmllbmQudG8uYXZhdGFyLFxyXG4gICAgICAgICAgICB0YWc6IGZyaWVuZC50by50YWdcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNyZWF0ZVRpbWU6IGZyaWVuZC5jcmVhdGVUaW1lLFxyXG4gICAgICAgIHN0YXR1czogZnJpZW5kLnN0YXR1c1xyXG4gICAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAgIGFkZEZyaWVuZCxcclxuICAgIHVwZGF0ZUZyaWVuZCxcclxuICAgIGZpbmRGcmllbmRCeVRvSWRzLFxyXG4gICAgZmluZEZyaWVuZEJ5VG9cclxufSJdfQ==